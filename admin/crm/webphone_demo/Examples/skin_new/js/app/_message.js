define(["jquery","common","stringres","global"],function(e,p,m,u){var s="";var i=false;var q=null;var o="";var D="";var d="";function w(F){try{p.PutToDebugLog(4,"_message: onCreate");e(window).resize(function(){if(e.mobile.activePage.attr("id")==="page_message"){l()}});e("#message_menu_ul").on("click","li",function(G){a(e(this).attr("id"))});e("#btn_message_menu").on("click",function(){k("#message_menu_ul")});e("#btn_message_menu").attr("title",m.get("hint_menu"));e("#msg_textarea").keyup(function(){e("#msg_charcount").text(e(this).val().length)});e("#btn_msgsend").on("click",function(){y()});e("#btn_msgsend").attr("title",m.get("hint_sendmsg"));e("#btn_msgpick").on("click",function(){p.PickContact(c)});e("#btn_msgpick").attr("title",m.get("hint_choosect"));e("#msg_btnback").attr("title",m.get("hint_btnback"))}catch(E){p.PutToDebugLogException(2,"_message: onCreate",E)}}function x(F){try{p.PutToDebugLog(4,"_message: onStart");u.isMessageStarted=true;e(".separator_line_thick").css("background-color",p.HoverCalc(p.getBgColor("#page_message"),-30));l();s=p.GetIntentParam(u.intentmsg,"action");o=p.GetIntentParam(u.intentmsg,"to");D=p.GetIntentParam(u.intentmsg,"message");if(!p.isNull(document.getElementById("msg_title"))&&!p.isNull(s)){if(s==="sms"){document.getElementById("msg_title").innerHTML=m.get("msg_title_sms")}else{document.getElementById("msg_title").innerHTML=m.get("msg_title_chat")}}if(!p.isNull(document.getElementById("msg_btnback"))){document.getElementById("msg_btnback").innerHTML="<span>&LT;</span>&nbsp;"+m.get("go_back_btn_txt")}if(p.isNull(o)){o=""}if(p.isNull(D)){D=""}C()}catch(E){p.PutToDebugLogException(2,"_message: onStart",E)}}function l(){try{var E=p.GetDeviceHeight()-e("#message_header").height()-e("#msg_textarea_container").height();if(document.getElementById("msgpick_container").style.display==="block"){E=E-e("#msgpick_container").height()}E=Math.floor(E-6);e("#msg_list").height(E)}catch(F){p.PutToDebugLogException(2,"_message: MeasureMessage",F)}}function C(){try{if(!p.isNull(o)&&o.length>0){document.getElementById("msgpick_input").value=o;var E=s+"_"+p.GetParameter("sipusername")+"_"+o;u.File.ReadFile(E,u.STORAGE_LOCAL,function(G){if(p.isNull(G)||p.Trim(G).length<1){p.PutToDebugLog(2,"ERROR, _message: LoadMessage no content");G="";document.getElementById("msgpick_container").style.display="block";l()}d=G;if(!p.isNull(D)&&D.length>0){b("1",true)}t()})}else{document.getElementById("msgpick_container").style.display="block";l();if(!p.isNull(D)&&D.length>0){b("1",true)}t()}}catch(F){p.PutToDebugLogException(2,"_message: LoadMessage",F)}}function t(){try{if(p.isNull(document.getElementById("page_message_content"))){p.PutToDebugLog(2,"ERROR, _message: PopulateList listelement is null");return}e("#msg_list").append(d);f();h()}catch(E){p.PutToDebugLogException(2,"_message: LoadMessage",E)}}function h(){try{var J=p.GetParameter("messagefiles");if(p.isNull(J)||J.length<3){p.PutToDebugLog(3,"EVENT, _message: RemoveNotification no message files");return}var I=[];if(!p.isNull(J)&&J.length>0){I=J.split(",")}var E=s+"_"+p.GetParameter("sipusername")+"_"+o+"[#";for(var G=0;G<I.length;G++){if(p.isNull(I[G])||I[G].length<3){continue}if(I[G].indexOf(E)===0){var K=I[G].indexOf("[#");I[G]=I[G].substring(0,K);J="";for(var F=0;F<I.length;F++){J=J+","+I[F]}if(J.indexOf(",")===0){J=J.substring(1)}if(J.lastIndexOf(",")===J.length-1){J=J.substring(0,J.length-1)}p.SaveParameter("messagefiles",J);break}}}catch(H){p.PutToDebugLogException(2,"_message: RemoveNotification",H)}}function c(F){try{document.getElementById("msgpick_input").value=F}catch(E){p.PutToDebugLogException(2,"_message: PickContactResult",E)}}function y(){try{if(p.isNull(q)){q=document.getElementById("msg_textarea");if(p.isNull(q)){p.PutToDebugLog(2,"ERROR, _message: SendMessage textarea is NULL");return}}D=q.value;if(p.isNull(o)||o.length<1){var E=document.getElementById("msgpick_input").value;if(p.isNull(E)||(p.Trim(E)).length<1){if(s==="sms"){p.ShowToast(m.get("err_msg_5"))}else{p.ShowToast(m.get("err_msg_6"))}return}else{o=E}}if(p.isNull(D)||(p.Trim(D)).length<1){q.value="";return}if(s==="sms"){i=true}else{wphone.sendchat(1,o,D);i=true}q.value="";if(i){b("1",false);setTimeout(function(){p.ShowToast(m.get("message_sent"));setTimeout(function(){q.focus()},3500)},1500)}else{b("0",false)}q.focus()}catch(F){p.PutToDebugLogException(2,"_message: SendMessage",F)}}var A=new Array();A[0]="Jan";A[1]="Feb";A[2]="Mar";A[3]="Apr";A[4]="May";A[5]="Jun";A[6]="Jul";A[7]="Aug";A[8]="Sep";A[9]="Oct";A[10]="Nov";A[11]="Dec";function v(){try{var F=new Date();var G=F.getMinutes();if(G<10){G="0"+G}var E=F.getDate();if(E<10){E="0"+E}var I=A[F.getMonth()]+", "+E+" "+F.getFullYear()+" "+F.getHours()+":"+G;return I}catch(H){p.PutToDebugLogException(2,"_message: GetDateForMessage",H)}return""}function b(O,E){var N=0;try{if(p.isNull(D)){p.PutToDebugLog(3,"ERROR, _message: AddMessage message is empty (null)");return}N=1;var L="";if(E){L=p.GetContactNameFromNumber(o)}else{L=m.get("me")}var R="<b>"+L+":</b><p>"+D+'</p><p class="date">'+v()+"</p>";e("#msg_list").append(R);f();if(p.isNull(o)||o.length<1){p.PutToDebugLog(2,"ERROR, _message: AddMessage destination number is NULL");return}var H=s+"_"+p.GetParameter("sipusername")+"_"+o;var G=p.GetParameter("messagefiles");var F=[];if(!p.isNull(G)&&G.length>0){F=G.split(",")}var I=false;for(var M=0;M<F.length;M++){if(p.isNull(F[M])){continue}var Q=F[M];var P=Q.indexOf("[#");if(P>0){Q=Q.substring(0,P)}if(Q===H){F.splice(M,1);F.unshift(H);G="";for(var K=0;K<F.length;K++){G=G+","+F[K]}if(G.indexOf(",")===0){G=G.substring(1)}if(G.lastIndexOf(",")===G.length-1){G=G.substring(0,G.length-1)}p.SaveParameter("messagefiles",G);I=true;break}}if(!I){if(G.length>0){G=H+","+G;if(G.indexOf(",")===0){G=G.substring(1)}if(G.lastIndexOf(",")===G.length-1){G=G.substring(0,G.length-1)}}else{G=H}p.SaveParameter("messagefiles",G)}if(d.length<1){if(p.IsWindowsSoftphone()){p.ApiWinLoadFile(H,function(S){if(!p.isNull(S)||p.Trim(S).length>0){d=S}d=d+R;p.ApiWinSaveFile(H,d,function(T){if(T){p.PutToDebugLog(2,"ERROR, _message: AddMessage cannot save message file (1) WinApi")}})})}else{u.File.ReadFile(H,u.STORAGE_LOCAL,function(S){if(!p.isNull(S)||p.Trim(S).length>0){d=S}d=d+R;u.File.SaveFile(H,d,u.STORAGE_LOCAL,function(T){if(!T){p.PutToDebugLog(2,"ERROR, _message: AddMessage cannot save message file (1)")}})})}}else{d=d+R;if(p.IsWindowsSoftphone()){p.ApiWinSaveFile(H,d,function(S){if(!S){p.PutToDebugLog(2,"ERROR, _message: AddMessage cannot save message file (2) WinApi")}})}else{u.File.SaveFile(H,d,u.STORAGE_LOCAL,function(S){if(!S){p.PutToDebugLog(2,"ERROR, _message: AddMessage cannot save message file (2)")}})}}}catch(J){p.PutToDebugLogException(2,"_message: AddMessage ("+N.toString()+")",J)}}function B(L,Q,G,J){try{var T="<b>"+G+":</b><p>"+J+'</p><p class="date">'+v()+"</p>";if(p.isNull(Q)||Q.length<1){p.PutToDebugLog(2,"ERROR, _message: SaveMissedIncomingMessage source number is NULL");return}var H=L+"_"+p.GetParameter("sipusername")+"_"+Q;var F=p.GetParameter("messagefiles");var E=[];if(!p.isNull(F)&&F.length>0){E=F.split(",")}var I=false;var P=0;for(var N=0;N<E.length;N++){if(p.isNull(E[N])){continue}var S=E[N];var O=S.indexOf("[#");if(O>0){S=S.substring(0,O)}if(S===H){if(O>0){var R=p.Trim(E[N].substring(O+2));if(R.length>0){try{P=p.StrToInt(R)}catch(K){}}}P=P+1;E.splice(N,1);E.unshift(H+"[#"+P);F="";for(var M=0;M<E.length;M++){F=F+","+E[M]}if(F.indexOf(",")===0){F=F.substring(1)}if(F.lastIndexOf(",")===F.length-1){F=F.substring(0,F.length-1)}p.SaveParameter("messagefiles",F);I=true;break}}if(!I){if(F.length>0){F=H+"[#1,"+F}else{F=H+"[#1"}p.SaveParameter("messagefiles",F)}if(p.IsWindowsSoftphone()){p.ApiWinLoadFile(H,function(U){if(p.isNull(U)){U=""}U=U+T;p.ApiWinSaveFile(H,U,function(V){if(!V){p.PutToDebugLog(2,"ERROR, _message: SaveMissedIncomingMessage cannot save message file (1) WinApi")}})})}else{u.File.ReadFile(H,u.STORAGE_LOCAL,function(U){if(p.isNull(U)){U=""}U=U+T;u.File.SaveFile(H,U,u.STORAGE_LOCAL,function(V){if(!V){p.PutToDebugLog(2,"ERROR, _message: SaveMissedIncomingMessage cannot save message file (1)")}})})}}catch(K){p.PutToDebugLogException(2,"_message: SaveMissedIncomingMessage",K)}}function r(G,I,H){try{if(I===o){H=p.ReplaceAll(H,"\\<.*?>","");D=H;b("1",true)}else{var E=p.GetContactNameFromNumber(I);p.PutNotifications(E,I,false);B(G,I,E,H)}}catch(F){p.PutToDebugLogException(2,"_message: ShowIncomingMessage",F)}}function f(){try{var F=e("#msg_list");F.scrollTop(F.prop("scrollHeight"))}catch(E){p.PutToDebugLogException(2,"_message: ScrollToBottom",E)}}var n="#menuitem_message_delete";function k(F){try{if(p.GetParameter("devicetype")===p.DEVICE_WIN_SOFTPHONE()){e("#btn_message_menu").removeAttr("data-transition")}if(p.isNull(F)||F.lenght<1){p.PutToDebugLog(2,"ERROR, _message: CreateOptionsMenu menuid null");return}if(e(F).length<=0){p.PutToDebugLog(2,"ERROR, _message: CreateOptionsMenu can't get reference to Menu");return}if(F.charAt(0)!=="#"){F="#"+F}e(F).html("");e(F).append('<li id="'+n+'"><a data-rel="back">'+m.get("delete_text")+"</a></li>").listview("refresh");return true}catch(E){p.PutToDebugLogException(2,"_message: CreateOptionsMenu",E)}return false}function a(F){try{if(p.isNull(F)||F.length<1){return}e("#message_menu").on("popupafterclose",function(G){e("#message_menu").off("popupafterclose");switch(F){case n:z();break}})}catch(E){p.PutToDebugLogException(2,"_message: MenuItemSelected",E)}}function z(E){try{var H=p.GetParameter("messagefiles");if(p.isNull(H)||H.length<3||p.isNull(o)||o.length<1){p.ShowToast(m.get("err_msg_7"));return}var I=p.GetDeviceWidth();if(!p.isNull(I)&&p.IsNumber(I)&&I>100){I=Math.floor(I/1.2)}else{I=220}var F='<div data-role="popup" class="ui-content messagePopup" data-overlay-theme="a" data-theme="a" style="max-width:'+I+'px;"><div data-role="header" data-theme="b"><a href="#" data-role="button" data-icon="delete" data-iconpos="notext" class="ui-btn-right closePopup">Close</a><h1 class="adialog_title">'+m.get("delete_text")+'</h1></div><div role="main" class="ui-content adialog_content adialog_alert"><span> '+m.get("delete_msg_alert")+' </span></div><div data-role="footer" data-theme="b" class="adialog_footer"><a href="#" id="btn_adialog_ok" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b adialog_2button" data-rel="back" data-transition="flow">'+m.get("btn_ok")+'</a><a href="#" id="adialog_negative" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b adialog_2button" data-rel="back">'+m.get("btn_cancel")+"</a></div></div>";E=E?E:function(){};e.mobile.activePage.append(F).trigger("create");e.mobile.activePage.find(".closePopup").bind("tap",function(J){e.mobile.activePage.find(".messagePopup").popup("close")});e.mobile.activePage.find(".messagePopup").bind({popupbeforeposition:function(){e(this).unbind("popupbeforeposition");var J=Math.floor(p.GetDeviceHeight()*0.6);if(e(this).height()>J){e(".messagePopup .ui-content").height(J)}}});e.mobile.activePage.find(".messagePopup").popup().popup("open").bind({popupafterclose:function(){e(this).unbind("popupafterclose").remove();e("#btn_adialog_ok").off("click");E()}});e("#btn_adialog_ok").on("click",function(){e.mobile.activePage.find(".messagePopup").on("popupafterclose",function(O){e(this).off("popupafterclose");var J=s+"_"+p.GetParameter("sipusername")+"_"+o;var N=H.split(",");for(var M=0;M<N.length;M++){if(p.isNull(N[M])){continue}var L=N[M];var P=L.indexOf("[#");if(P>0){L=L.substring(0,P)}if(L===J){N.splice(M,1);H="";for(var K=0;K<N.length;K++){H=H+","+N[K]}if(H.indexOf(",")===0){H=H.substring(1)}if(H.lastIndexOf(",")===H.length-1){H=H.substring(0,H.length-1)}p.SaveParameter("messagefiles",H);break}}u.File.DeleteFile(J,function(Q){p.PutToDebugLog(3,"EVENT, _message: ClearHistory DeleteFile: "+J+" status: "+Q.toString())});e.mobile.back()})})}catch(G){p.PutToDebugLogException(2,"_message: ClearHistory",G)}}function j(F){try{p.PutToDebugLog(4,"_message: onStop");u.isMessageStarted=false;document.getElementById("msgpick_input").value="";document.getElementById("msg_list").innerHTML="";document.getElementById("msg_textarea").value="";document.getElementById("msg_charcount").innerHTML="0";document.getElementById("msgpick_container").style.display="none";s="";i=false;o="";D="";d=""}catch(E){p.PutToDebugLogException(2,"_message: onStop",E)}}function g(F){try{p.PutToDebugLog(4,"_message: onDestroy");u.isMessageStarted=false;p.SaveContactsFile(function(G){p.PutToDebugLog(4,"EVENT, _message: onDestroy SaveContactsFile: "+G.toString())})}catch(E){p.PutToDebugLogException(2,"_message: onDestroy",E)}}return{onCreate:w,onStart:x,onStop:j,onDestroy:g,ShowIncomingMessage:r,SaveMissedIncomingMessage:B}});