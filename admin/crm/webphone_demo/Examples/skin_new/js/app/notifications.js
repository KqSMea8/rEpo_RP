define(["jquery","common","global","_call","_message","stringres"],function(E,v,a,b,I,r){var O=8000;var w=false;var d=false;var ac="";var x=false;var t=0;var D=0;var c=0;var W=false;var q=0;var H="";var k=0;var X=0;var L=0;var U=100;var f=100;var h=false;function M(){try{H=r.get("balance_uri");if(v.isNull(H)){H=""}a.creditRequestIval=100;w=false}catch(ad){v.PutToDebugLogException(2,"notifications: Init",ad)}}function m(ad){try{if(!a.initcalled){a.initcalled=true;M()}if(!w){w=true;a.maintimerid=setInterval(function(){ab()},U)}if(v.isNull(ad)){return}if(ad.indexOf("EOFLINE")>0){var ag=ad.split("EOFLINE");for(var ae=0;ae<ag.length;ae++){if(!v.isNull(ag[ae])){ag[ae]=ag[ae].replace("EOFLINE","");ag[ae]=v.Trim(ag[ae]);if(ag[ae].length>0){l(ag[ae])}}}}else{ad=ad.replace("EOFLINE","");ad=v.Trim(ad);if(ad.length>0){l(ad)}}}catch(af){v.PutToDebugLogException(2,"notifications: ReceiveNotifications",af)}}var i="";var g="";var B="";var o="";var n="";var G="";function l(ae){try{if(v.isNull(ae)||ae.length<1){return}o=ae.trim();i="";g="";var al=0;if(o.charAt(0)==="["){al=o.indexOf("]");if(al>0){o=v.Trim(o.substring(al+1,o.length))}}al=o.indexOf(",");if(al>0){i=v.Trim(o.substring(0,al));o=v.Trim(o.substring(al+1,o.length))}else{i="EVENT"}if(i==="STATUS"||i==="CDR"||i==="CHAT"||i==="SUBSCRIBE"||i==="NOTIFY"||i==="EVENT"||i==="ERROR"||i==="WARNING"||i==="POPUP"||i==="CREDIT"||i==="RATING"||i==="MWI"){if(i==="STATUS"){wphone.RecStat(o)}else{if(i==="EVENT"||i==="CREDIT"||i==="RATING"||i==="MWI"){wphone.RecEvt(o)}else{if(i==="NOTIFY"){wphone.RecNot(o)}}}}else{v.PutToDebugLog(5,"WARNING, unknown notification a: "+ae);return}if(i==="CREDIT"){W=true;a.credit=" "+o}else{if(i==="RATING"){a.rating=" ("+v.Trim(o)+")"}else{if(i==="MWI"){}}}if(!W&&q===0){if(H.length>0){v.UriParser(H,"","","","","creditrequest")}}q++;if(q>a.creditRequestIval){q=0}al=o.indexOf(",");if(al>0){o=v.Trim(o.substring(al+1,o.length))}al=o.indexOf(",");if(al>0){g=v.Trim(o.substring(0,al));o=v.Trim(o.substring(al+1,o.length))}else{g=o}al=g.indexOf("(");if(al>0){g=v.Trim(g.substring(0,al))}if(g.length<1){v.PutToDebugLog(5,"WARNING, unknown notification b: "+ae);return}if(o.length<1){v.PutToDebugLog(5,"WARNING, unknown notification c: "+ae);return}if(i==="CDR"){v.PutToDebugLog("EVENT, notifications: ProcessNotifications CDR received: "+ae,5);al=ae.indexOf(",");if(al>0){try{var af="";var ah=ae.split(",");v.PutToDebugLog(1,"EVENT, "+ah[9]);af=v.Trim(ah[2]);var an=0;try{an=(v.StrToInt(ah[7]))/1000}catch(am){}var aj="recfile";if(d===true){d=false;if(a.acceptReject===false){S(af,"2",aj,an)}else{S(af,"1",aj,an)}a.acceptReject=false}else{S(af,"0",aj,an)}ac="";aj=""}catch(ag){v.PutToDebugLogException(2,"notifications: ProcessNotifications CDR and save to call history",ag)}}}if(i==="STATUS"){if(g==="Call Finished"){x=true;t=v.GetTickCount();if(a.isCallStarted){E("#btn_hangup_img").attr("src","images/btn_close_txt.png");E("#callfunctions_layout").hide()}a.hangupPressedCount=1;a.checkIfInCall=false;a.checkIfCallActive=false;a.callTypeInOut="";a.lastRingEvenet=""}if(g==="Finished"){if(a.incommingCall===true&&a.acceptReject===false){if(a.isCallStarted){b.OnCallerHangup()}}a.checkIfInCall=false;a.checkIfCallActive=false;a.incommingCall=false;a.holdState=true;a.muteState=true;a.speakerState=true;a.bluetoothState=true;a.lastBTclicktick=0;a.callTypeInOut="";a.lastRingEvenet=""}if(g==="Ringing"){var ad=ae.replace(" ","");D=v.GetTickCount();al=o.indexOf(",");if(al>=0&&ac.length<1){ac=o.substring(0,al)}a.checkIfInCall=true;a.checkIfCallActive=false;var ai="";al=o.indexOf(",");if(al>0){ai=o.substring(al+1)}al=ai.indexOf(",");if(al>0){ai=ai.substring(al+1)}al=ai.indexOf(",");if(al>0){ai=ai.substring(0,al)}if(!v.isNull(ai)&&ai==="2"&&ad!==a.lastRingEvenet){a.incommingCall=true;d=true;a.checkIfInCall=true;a.checkIfCallActive=false;v.SaveParameter("redial",ac);a.intentcall[0]="number="+ac;a.intentcall[1]="calltype=incoming";a.intentcall[2]="name=";setTimeout(function(){E.mobile.changePage("#page_call",{transition:"pop",role:"page"})},20)}if(v.isNull(a.lastRingEvenet)||a.lastRingEvenet.length<1){a.lastRingEvenet=ad}}if(g==="Starting call"){a.checkIfInCall=true;a.checkIfCallActive=false}if(g==="Speaking"){h=true;if(a.incommingCall){a.incommingCall=false}a.checkIfCallActive=true;a.lastRingEvenet=""}if(g.toLowerCase().indexOf("registered")>=0){if(c<4){c=4}}}else{if(i==="CHAT"){F(g,o)}}al=o.indexOf(",");if(al>0){o=g}al=g.indexOf("[ep");if(al>0){g=v.Trim(g.substring(0,al));o=g}var ak="";if(i==="EVENT"||i==="ERROR"||i==="WARNING"||i==="STATUS"){al=o.indexOf("(");if(al>0){ak=v.Trim(o.substring(0,al))}else{ak=o}if(!v.IsNumber(ak.charAt(0))){ak=ak.substring(0,1).toUpperCase()+ak.substring(1);if(i==="STATUS"){if(ak!=="Deletable"&&ak.indexOf("Chat")<0){j=ak}}else{n=ak;G=i}}}if(i==="POPUP"){v.ShowToast(o)}}catch(ag){v.PutToDebugLogException(2,"notifications: ProcessNotifications",ag)}}var z=0;var P=24;var j="";var R="";var N="";var J=Math.floor(300000/U);var Z=true;var p=true;var Q=false;var e=0;var Y=0;var T="";var aa=0;var C=0;function ab(){try{if(z<5000){z++}if(n.length>0){if(n.toLowerCase().indexOf("authenticated successfully")>=0){j="Registered."}R=n;N=G;z=0;n="";G=""}else{if(z>P){R=j;N="STATUS"}}try{var aj=R.indexOf("[");if(aj>0){R=R.substring(0,aj)}R=v.Trim(R);aj=R.indexOf("]");if(aj>0){R=R.substring(aj+1)}R=v.Trim(R)}catch(al){v.PutToDebugLogException(3,"notifications OnTimerCycle parse displayed status",al)}if(R==="Registered."){R+=a.credit}if(R.indexOf("Credit:")!==0&&R.indexOf("Credit:")!==1&&R.indexOf("Outband")<0){if(R.toLowerCase().indexOf("hide")>=0){R=" "}K(R,N)}if(x){if(v.GetTickCount()-t>O){x=false;t=0;if(a.incommingCall===false&&a.checkIfInCall===false&&a.isCallStarted){b.CloseCall()}}}k++;if(k>50){if(a.wasSettModified){k=0;a.wasSettModified=false;v.SaveSettingsFile(v.GetActiveAccSettingsFilename(),function(ar){if(ar){v.PutToDebugLog(2,"EVENT, SaveSettingsFile from timer Successfull")}else{v.PutToDebugLog(2,"ERROR, SaveSettingsFile from timer Failed")}})}}X++;if(X>20){X=0;if(a.wasCtModified){a.wasCtModified=false;v.SaveContactsFile(function(ar){if(ar){v.PutToDebugLog(2,"EVENT, SaveContactsFile from timer Successfull")}else{v.PutToDebugLog(2,"ERROR, SaveContactsFile from timer Failed")}})}}L++;if(L>100){L=0;if(a.wasChModified){a.wasChModified=false;v.SaveCallhistoryFile(function(ar){if(ar){v.PutToDebugLog(2,"EVENT, SaveCallhistoryFile from timer Successfull")}else{v.PutToDebugLog(2,"ERROR, SaveCallhistoryFile from timer Failed")}})}}if(g==="Ringing"&&Z===true){e=v.GetTickCount();Z=false;Q=true}if(g==="Speaking"&&p===true){e=v.GetTickCount();p=false;Q=true}if(Q===true){Y++;if(Y>=3){if(a.holdState===false){T=r.get("in_hold")+" "}else{T=""}var ae=v.GetTickCount()-e;var an=Math.floor(ae/1000);var ah=Math.floor(an/60);an=an%60;if(an<10){an="0"+an}if(a.isCallStarted){E("#call_duration").html(T+ah+":"+an+"&nbsp;")}Y=0}}if(g==="Call Finished"||g==="Finished"){Q=false;Z=true;p=true}if(o.indexOf(":")>0){var ak=v.Trim(o.substring(0,o.indexOf(":")));if(ak==="Call duration"){Q=false;T=r.get("duration")+" ";var ao=v.Trim(o.substring(o.indexOf(":")+1,o.length));var am=0;var ah=0;var an=0;if(ao.indexOf(":")<0){an=v.Trim(ao.substring(0,ao.indexOf(" ")))}else{am=v.Trim(ao.substring(0,ao.indexOf(":")));ao=v.Trim(ao.substring(ao.indexOf(":")+1,ao.length));ah=v.Trim(ao.substring(0,ao.indexOf(":")));ao=v.Trim(ao.substring(ao.indexOf(":")+1,ao.length));an=v.Trim(ao.substring(0,ao.length))}if(!v.isNull(am)&&am.length>0&&v.IsNumber(am)){var aq=v.StrToInt(am);aq=aq*60;ah=ah+aq}if(a.isCallStarted){E("#call_duration").html(T+ah+":"+an+"&nbsp;")}if(h&&a.customizedversion===false){var af=v.StrToInt(ah);var ad=v.StrToInt(an);if(af>0||ad>30){var ai=0;try{ai=v.StrToInt(v.GetParameter("proversioncallcount"))}catch(ap){v.SaveParameter("proversioncallcount","0")}if(ai<25){ai++}v.SaveParameter("proversioncallcount",ai.toString());h=false}}}}C++;if(C>J){C=0;if(v.GetParameter("devicetype")===v.DEVICE_WIN_SOFTPHONE()){v.WinAPI("API_HTTPKeepAlive",function(ar){v.PutToDebugLog(2,"EVENT, notifications OnTimerCycle API_HTTPKeepAlive response: "+ar)})}}}catch(ag){v.PutToDebugLogException(2,"notifications: OnTimerCycle",ag)}}function S(af,ad,ao,ai){try{v.PutToDebugLog(4,"EVENT, notifications CDR added; AddToCallLog(); number: "+af+"; type: "+ad+"; recorded: "+ao+"; duration: "+ai+"; callDateTime = "+D);if(v.isNull(af)&&af.length<1){return}var al=0;if(D>0){al=D}else{al=v.GetTickCount()}D=0;var aj=0;var am=0;var ae="";try{ai=Math.floor(ai);aj=Math.floor(ai/60);am=ai%60;if(aj<10){ae+="0"}if(aj===0){ae+="0:"}else{ae+=aj+":"}if(am<10){ae+="0"}ae+=am}catch(an){v.PutToDebugLogException(3,"notifications AddToCallLog calc duration",an)}if(v.isNull(a.callName)){a.callName=""}if(v.isNull(ad)){ad=""}if(v.isNull(ao)){ao=""}var ak=a.callName;if(v.isNull(ak)||ak.length<1){ak=af}var ag=[ad,ak,af,""+al+"",""+ai+"",ao];a.chlist.unshift(ag);a.wasChModified=true;if(ad==="2"){v.PutNotifications(ak,af,true)}}catch(ah){v.PutToDebugLogException(2,"notifications: AddToCallLog",ah)}}function F(ag,af){try{if(a.isMessageStarted){I.ShowIncomingMessage("chat",ag,af)}else{if(a.checkIfInCall){var ad=v.GetContactNameFromNumber(ag);v.PutNotifications(ad,ag,false);I.SaveMissedIncomingMessage("chat",ag,ad,af)}else{a.intentmsg[0]="action=chat";a.intentmsg[1]="to="+ag;a.intentmsg[2]="message="+af;E.mobile.changePage("#page_message",{transition:"slide",role:"page"})}}}catch(ae){v.PutToDebugLogException(2,"notifications: OnMessageReceived",ae)}}var u=null;var V=null;var A=null;var s=null;function K(ag,ae){try{if(v.isNull(ag)){return}if((v.Trim(ag)).length<1){ag="&nbsp"}var ad="#FFFFFF";if(v.isNull(ae)||ae.length<1){ae="EVENT"}if(ae==="ERROR"){ad="#FF0000"}if(ae==="WARNING"){ad="#D28F00"}if((ag.toLowerCase()).indexOf("success")>=0){ad="#4EC200"}if(v.isNull(u)){u=document.getElementById("status_dialpad")}if(v.isNull(V)){V=document.getElementById("status_contactslist")}if(v.isNull(A)){A=document.getElementById("status_callhistorylist")}if(v.isNull(s)){s=document.getElementById("status_call")}if(!v.isNull(u)){u.innerHTML=ag;u.style.color=ad}if(!v.isNull(V)){V.innerHTML=ag;V.style.color=ad}if(!v.isNull(A)){A.innerHTML=ag;A.style.color=ad}if(!v.isNull(s)){s.innerHTML=ag;s.style.color=ad}}catch(af){v.PutToDebugLogException(2,"notifications: DisplayStatus",af)}}var y={ReceiveNotifications:m};window.notifications_public=y;return{}});