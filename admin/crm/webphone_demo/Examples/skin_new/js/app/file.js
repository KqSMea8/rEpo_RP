define(["jquery","stringres","global","common","localforage"],function(h,c,e,i,q){function f(r,t,u){try{if(!u||typeof(u)!=="function"){i.PutToDebugLog(2,"ERROR, file: SetItem callback not defined");return}if(i.isNull(r)||i.isNull(t)){u(false);return}i.PutToDebugLog(2,"EVENT, file saved to localforage: "+r);q.setItem(r,t,function(v,w){if(v){i.PutToDebugLog(2,"ERROR, file: SetItem localforage returned error");u(false);return false}else{u(true);return true}})}catch(s){i.PutToDebugLogException(2,"file: SetItem",s)}}function j(r,t){try{if(!t||typeof(t)!=="function"){i.PutToDebugLog(2,"ERROR, file: GetItem callback not defined");return}if(i.isNull(r)){t(null);return}i.PutToDebugLog(2,"EVENT, file read from localforage: "+r);q.getItem(r,function(u,v){if(u){i.PutToDebugLog(2,"ERROR, file: GetItem localforage returned error");t("");return""}else{t(v);return v}});t("");return""}catch(s){i.PutToDebugLogException(2,"file: GetItem",s)}}function d(r,t){try{if(!t||typeof(t)!=="function"){i.PutToDebugLog(2,"ERROR, file: DeleteItem callback not defined");return}if(i.isNull(r)){t(false);return}i.PutToDebugLog(2,"EVENT, file deleted from localforage");q.removeItem(r,function(u){if(u){i.PutToDebugLog(2,"ERROR, file: DeleteItem localforage returned error");t(false);return false}else{t(true);return true}});t(false);return false}catch(s){i.PutToDebugLogException(2,"file: DeleteItem",s)}}function m(t,v,x,w){try{if(!w||typeof(w)!=="function"){i.PutToDebugLog(2,"ERROR, file: SetCookie callback not defined");return false}if(i.isNull(t)||i.isNull(v)){w(false);return false}var r="";if(!i.isNull(x)){var s=new Date();s.setTime(s.getTime()+(x*24*60*60*1000));r="; expires="+s.toGMTString()}else{r=""}document.cookie=t+"="+v+r+"; path=/";if(!i.isNull(v)){i.PutToDebugLog(2,"EVENT, file saved to cookie: "+t)}w(true);return true}catch(u){i.PutToDebugLogException(2,"file: SetCookie",u)}w(false)}function o(t,y){try{if(!y||typeof(y)!=="function"){i.PutToDebugLog(2,"ERROR, file: GetCookie callback not defined");return}if(i.isNull(t)){y(null);return}var w=t+"=";var r=document.cookie.split(";");for(var s=0;s<r.length;s++){var x=r[s];while(x.charAt(0)===" "){x=x.substring(1,x.length)}if(x.indexOf(w)===0){var v=x.substring(w.length,x.length);i.PutToDebugLog(2,"EVENT, file read from cookie: "+t);y(v);return}}}catch(u){i.PutToDebugLogException(2,"file: GetCookie",u)}y(null)}function p(){try{var v=document.cookie.split(";");for(var t=0;t<v.length;t++){var s=v[t];var w=s.indexOf("=");var r=w>-1?s.substr(0,w):s;document.cookie=r+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT"}return true}catch(u){i.PutToDebugLogException(2,"file: DeleteAllCookies",u)}return false}function b(r,t){try{if(!t||typeof(t)!=="function"){i.PutToDebugLog(2,"ERROR, file: DeleteCookie callback not defined");return}if(i.isNull(r)){t(false);return}i.PutToDebugLog(2,"EVENT, file deleted from cookie");m(r,"",-1,function(u){t(u)})}catch(s){i.PutToDebugLogException(2,"file: DeleteCookie",s)}}function a(){try{var r=document.cookie.split(";");for(var s=0;s<r.length;s++){var v=r[s];while(v.charAt(0)===" "){v=v.substring(1,v.length)}if(v.indexOf(nameEQ)===0){var u=v.substring(nameEQ.length,v.length);i.PutToDebugLog(2,"EVENT, file read from cookie: "+key);callback(u);return}}}catch(t){i.PutToDebugLogException(2,"file: GetCookie",t)}}function n(r,t,u,v){try{if(!v||typeof(v)!=="function"){i.PutToDebugLog(2,"ERROR, file: SaveFile callback not defined");return}if(i.isNull(r)){i.PutToDebugLog(3,"ERROR, file: SaveFile filename null");v(false);return}if(i.isNull(t)){i.PutToDebugLog(3,"ERROR, file: SaveFile content is NULL");v(false);return}if(i.isNull(u)||u<0||u>2){u=e.STORAGE_LOCAL}if(i.IsIeLocal()){u=e.STORAGE_COOKIE}if(t!==null){i.PutToDebugLog(3,"EVENT, file: SaveFile content code");t=i.Encrypt(t,i.enckey)}if(t===null){i.PutToDebugLog(2,"ERROR, file: SaveFile content after code is NULL")}if(u===e.STORAGE_LOCAL){f(r,t,function(w){i.PutToDebugLog(3,"EVENT, file: SaveFile SetItem callback");v(w)})}else{if(u===e.STORAGE_COOKIE){m(r,t,365,function(w){v(w)})}else{if(u===e.STORAGE_AUTO){o("notincoockie",function(x){var w=false;if(!i.isNull(x)&&x==="true"){w=true}if(w===true||t.length>1000){f(r,t,function(y){v(y)});if(t.length>1000){m("notincoockie","true",365,function(){})}}else{m(r,t,365,function(y){v(y)})}})}else{i.PutToDebugLog(2,"ERROR, file: SaveFile invalid storagetype");v(false);return}}}}catch(s){i.PutToDebugLogException(2,"file: SaveFile",s)}}function k(r,t,u){try{if(!u||typeof(u)!=="function"){i.PutToDebugLog(2,"ERROR, file: ReadFile callback not defined");return}if(i.isNull(t)||t<0||t>2){t=e.STORAGE_LOCAL}if(i.IsIeLocal()){t=e.STORAGE_COOKIE}if(i.isNull(r)){i.PutToDebugLog(3,"ERROR, file: ReadFile filename is NULL");u(null);return}if(t===e.STORAGE_LOCAL){j(r,function(v){if(!i.isNull(v)){i.PutToDebugLog(3,"EVENT, file: ReadFile content decode");v=i.Decrypt(v,i.enckey)}if(v===null){i.PutToDebugLog(3,"EVENT, file: ReadFile content after decode is null")}u(v)})}else{if(t===e.STORAGE_COOKIE){o(r,function(v){if(!i.isNull(v)){i.PutToDebugLog(3,"EVENT, file: ReadFile content decode");v=i.Decrypt(v,i.enckey)}if(v===null){i.PutToDebugLog(3,"EVENT, file: ReadFile content after decode is null")}u(v)})}else{if(t===e.STORAGE_AUTO){o("notincoockie",function(w){var v=false;if(!i.isNull(w)&&w==="true"){v=true}if(t===e.STORAGE_LOCAL||v===true){j(r,function(x){if(!i.isNull(x)){i.PutToDebugLog(3,"EVENT, file: ReadFile content decode");x=i.Decrypt(x,i.enckey)}if(x===null){i.PutToDebugLog(3,"EVENT, file: ReadFile content after decode is null")}u(x)})}else{o(r,function(x){if(!i.isNull(x)){i.PutToDebugLog(3,"EVENT, file: ReadFile content decode");x=i.Decrypt(x,i.enckey)}if(x===null){i.PutToDebugLog(3,"EVENT, file: ReadFile content after decode is null")}u(x)})}})}else{i.PutToDebugLog(2,"ERROR, file: ReadFile invalid storagetype");u(false);return}}}}catch(s){i.PutToDebugLogException(2,"file: ReadFile",s)}}function g(s,u){try{if(!u||typeof(u)!=="function"){i.PutToDebugLog(2,"ERROR, file: DeleteFile callback not defined");return}if(i.isNull(s)){i.PutToDebugLog(3,"ERROR, file: DeleteFile filename null");u(false);return}var r=false;b(s,function(v){if(!r){u(true)}r=true});if(i.IsIeLocal()){return}d(s,function(v){if(!r){u(true)}r=true})}catch(t){i.PutToDebugLogException(2,"file: DeleteFile",t)}}var l={SaveFile:n,ReadFile:k,DeleteFile:g,SetItem:f,GetItem:j,SetCookie:m,GetCookie:o,DeleteAllCookies:p};e.File=l;window.file_public=l;return{SaveFile:n,ReadFile:k,DeleteFile:g}});