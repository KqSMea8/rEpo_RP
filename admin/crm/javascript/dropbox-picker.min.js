angular.module("dropbox-picker", []).provider("DropBoxSettings", function() {
     this.$get = function() {
        return {
            linkType: 'direct'
        }
    },
    this.configure = function(e) {
        for (key in e) this[key] = e[key]
    }

})
.directive("dropBoxPicker", ["DropBoxSettings",
            function(DropBoxSettings) {
    return {
        restrict: "A",
        scope: {
            dbpickerFiles: "="
        },
        link: function(scope, element, attrs) {
            function instanciate() {
                Dropbox.choose(dropboxOptions);
            }
            var dropboxOptions = {
                success: dropboxsuccess,
                cancel: function() {},
                linkType : DropBoxSettings.linkType,
            };
            function dropboxsuccess(files){
            	
                /*scope.$apply(function() {
                    for (var i = 0; i < files.length; i++){
                        scope.dbpickerFiles.push(files[i]);
                    }*/
               // });
            	 scope.dbpickerFiles = files;
                saveFile(scope.dbpickerFiles);
            };
            function saveFile(files){
            	 ShowHideLoader('1','P');
            	 oldurl = $("#form1").find("input[name='OldFile']").val();
            	 var newurl = $("#form1").find("input[name='NewFile']").val();
            	 $.ajax({
                     url : "ajax.php",
                     type: "POST",
                     data : { dropboxdownloadUrl:files[0].link, fileName:files[0].name, NewFile:newurl},
                     success: function(data)
                     {
	            		 //console.log(data);
	            		 data = $.parseJSON(data);
	    				 ShowHideLoader('2','P');
	    				 if(data.flag==0){
	    					 alert(data.msg);
	    						return false;
	    				 }
	                     if(data.fileName){
	                         //alert(data.fileName);
	                         $("#DocDiv,#FileNameerr").remove();
	                        var downloadLink = '<div  id="DocDiv" style="padding:10px 0 10px 0;">'+ data.fileName +'&nbsp;&nbsp;&nbsp;'+
	                         '<a href="dwn.php?file='+ data.fileUrl +'" class="download">Download</a>' + 
	                         '<a href="Javascript:void(0);" onclick="Javascript:DeleteFile(\''+ data.fileUrl +'\',\'DocDiv\')"><img src="../images/delete.png" border="0" onmouseover="ddrivetip(<center>Delete</center>, 40)" ></a>'+
	                         '<input type="hidden" name="OldFile" value="'+ oldurl +'"><input type="hidden" name="NewFile" value="'+ data.fileUrl +'">' +
	                         '</div>';
	                        $(downloadLink).insertBefore("#pick");
	    	                }else{
	    	                    alert('Error while uploading file. Try again.');
	    	                }
                     }
            	 });
            	
            };
            element.bind("click", function() {
                instanciate()
            })
        }
    }
}])


