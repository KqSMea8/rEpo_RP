<?php 
	/**************************************************/
	$ThisPageName = 'viewPO.php'; $EditPage = 1; $SetFullPage = 1;
	/**************************************************/

	include_once("../includes/header.php");
	require_once($Prefix."classes/purchase.class.php");
	require_once($Prefix."classes/inv_tax.class.php");
	require_once($Prefix."classes/purchasing.class.php");
	require_once($Prefix."classes/sales.quote.order.class.php");
        require_once($Prefix."classes/inv.condition.class.php");
	$objCommon=new common();
	$objPurchase=new purchase();
	$objSale = new sale();
	$objTax=new tax();
        $objCondition = new condition();
	(!$_GET['module'])?($_GET['module']='Quote'):(""); 
	$module = $_GET['module'];
	$ModuleName = "Purchase ".$_GET['module'];

	$RedirectURL = "viewPO.php?module=".$module."&curP=".$_GET['curP'];
	$EditUrl = "editPO.php?module=".$module."&curP=".$_GET['curP'];


	if($module=='Quote'){	
		$ModuleIDTitle = "Quote Number"; $ModuleID = "QuoteID"; $PrefixPO = "QT"; 
		$UpdateMSG = PO_QUOTE_UPDATED;  $AddMSG = PO_QUOTE_ADDED; $RemoveMSG = PO_QUOTE_REMOVED; $NotExist = NOT_EXIST_QUOTE; 

		$ApproveMSG = APPROVE_QT_MSG; $ApprovedSucc = APPROVED_QT;
		$CancelMSG = CANCEL_QT_MSG; $CanceledSucc = CANCELED_QT;
		$RejectMSG = REJECT_QT_MSG; $RejectedSucc = REJECT_QT;

		
	}else{
		$ModuleIDTitle = "PO Number"; $ModuleID = "PurchaseID"; $PrefixPO = "PO"; 
		$UpdateMSG = PO_ORDER_UPDATED;  $AddMSG = PO_ORDER_ADDED; $RemoveMSG = PO_ORDER_REMOVED; $NotExist = NOT_EXIST_ORDER;

		$ApproveMSG = APPROVE_PO_MSG; $ApprovedSucc = APPROVED_PO;
		$CancelMSG = CANCEL_PO_MSG; $CanceledSucc = CANCELED_PO;
		$RejectMSG = REJECT_PO_MSG; $RejectedSucc = REJECT_PO;
	}




	 if(!empty($_GET['Approve'])){
		$_SESSION['mess_purchase'] = $ApprovedSucc;
		$objPurchase->AuthorizePurchase($_GET['Approve'],1,'');
		$EditUrl .= "&edit=".$_GET['Approve'];
		header("Location:".$EditUrl);
		exit;
	}else if(!empty($_GET['Cancel'])){
		$_SESSION['mess_purchase'] = $CanceledSucc;
		$objPurchase->AuthorizePurchase($_GET['Cancel'],2,'');
		$EditUrl .= "&edit=".$_GET['Cancel'];
		header("Location:".$EditUrl);
		exit;
	}else if(!empty($_GET['Reject'])){
		$_SESSION['mess_purchase'] = $RejectedSucc;
		$objPurchase->AuthorizePurchase($_GET['Reject'],3,'');
		$EditUrl .= "&edit=".$_GET['Reject'];
		header("Location:".$EditUrl);
		exit;

	}else if(!empty($_GET['Complete'])){
		$_SESSION['mess_purchase'] = COMPLETED_PO;
		$objPurchase->AuthorizePurchase($_GET['Complete'],'',1);
		$EditUrl .= "&edit=".$_GET['Complete'];
		header("Location:".$EditUrl);
		exit;

	}else if($_GET['del_id'] && !empty($_GET['del_id'])){
		$_SESSION['mess_purchase'] = $RemoveMSG;
		$objPurchase->RemovePurchase($_GET['del_id']);
		header("Location:".$RedirectURL);
		exit;
	}


	
	 if($_POST) {
			
			if(!empty($_POST['ConvertOrderID'])) {
				$objPurchase->ConvertToPo($_POST['ConvertOrderID'],$_POST['PurchaseID']);
				$_SESSION['mess_purchase'] = QUOTE_TO_PO_CONVERTED;
				$RedirectURL = "viewPO.php?module=Order";
				header("Location:".$RedirectURL);
				exit;
			 } 

			 
			 if($_POST['OrderType']!='Dropship') {
				$_POST['SaleID']='';
			 }


			 if(empty($_POST['SuppCode'])) {
				$errMsg = ENTER_SUPPLIER_ID;
			 } else {
				if (!empty($_POST['OrderID'])) {
					$objPurchase->UpdatePurchase($_POST);
					$order_id = $_POST['OrderID'];
					$_SESSION['mess_purchase'] = $UpdateMSG;
				}else {	 
					$order_id = $objPurchase->AddPurchase($_POST); 
					$_SESSION['mess_purchase'] = $AddMSG;
					
					$objPurchase->sendPurchaseEmail($order_id);					
				}

				
				$objPurchase->AddUpdateItem($order_id, $_POST); 
				
				if(!empty($_POST['SaleID'])) {
					$objPurchase->AlterSaleItem($order_id, $_POST); 
				}


				/***********************************/
				if($_POST['EmpID']>0 && $_POST['OldEmpID']!=$_POST['EmpID']){
					$objPurchase->sendAssignedEmail($order_id, $_POST['EmpID']); 
				}
				/***********************************/

				header("Location:".$RedirectURL);
				exit;
				
			}
		}
		

	if(!empty($_GET['edit'])){
		$arryPurchase = $objPurchase->GetPurchase($_GET['edit'],'',$module);
		$OrderID   = $arryPurchase[0]['OrderID'];
		$SaleID   = $arryPurchase[0]['SaleID'];

		/*****************/
		if($Config['vAllRecord']!=1){
			if($arryPurchase[0]['AssignedEmpID'] != $_SESSION['AdminID'] && $arryPurchase[0]['AdminID'] != $_SESSION['AdminID']){
			header('location:'.$RedirectURL);
			exit;
			}
		}
		/*****************/

	
		if($OrderID>0){
			$arryPurchaseItem = $objPurchase->GetPurchaseItem($OrderID);
			$NumLine = sizeof($arryPurchaseItem);
			$NumPoItem = sizeof($arryPurchaseItem);
		}else{
			$ErrorMSG = $NotExist;
		}
	}else{
		$arryPurchase[0]['Taxable'] = 'Yes';
		
	}
				

		


 	$arryPurchaseTax = $objTax->GetTaxByLocation('2',$arryCurrentLocation[0]['country_id'],$arryCurrentLocation[0]['state_id']);

	//$arryPurchaseTax = $objTax->GetTaxRate('2');

	$arryPaymentTerm = $objConfigure->GetTerm('','1');
	$arryPaymentMethod = $objConfigure->GetAttribFinance('PaymentMethod','');
	$arryShippingMethod = $objConfigure->GetAttribValue('ShippingMethod','');
	$arryOrderType = $objCommon->GetFixedAttribute('OrderType','');		

	/*******************/
	$arryOrderStatusTemp = $objCommon->GetFixedAttribute('OrderStatus','');		
	for($i=0;$i<sizeof($arryOrderStatusTemp);$i++) {
		$arryOrderStatus[] = $arryOrderStatusTemp[$i]['attribute_value'];
	}
	if(in_array($arryPurchase[0]['Status'],$arryOrderStatus) && $arryPurchase[0]['Approved'] == 1){
		$OrderIsOpen = 1;
	}else if($arryPurchase[0]['Status'] == 'Cancelled' || $arryPurchase[0]['Status'] == 'Rejected'){
		$CancelledRejected = 1;
		$HideSubmit = 1;
	}else if($arryPurchase[0]['Status'] == 'Completed'){
		$Completed = 1;
		$HideSubmit = 1;
	}
	/*******************/


	/************************************/
	/************************************/
	if(!empty($_GET['SaleID'])){
		
		$SaleID   = $_GET['SaleID'];
		$arryPurchase[0]['OrderType'] = 'Dropship';

		$arrySale = $objSale->GetSale('',$SaleID,'Order');

		if($arrySale[0]['OrderID']>0){
			$arrySaleItem = $objSale->GetSaleItem($arrySale[0]['OrderID']);
			$NumSaleItem = sizeof($arrySaleItem);
			if($NumSaleItem>0){
				$TotalAmount=0;
				
				if($NumPoItem>0){ // Append Items
					unset($arryPurchaseItem);
					for($i=0;$i<$NumSaleItem;$i++) { 
						//dd
					}
				}
				#else{ // Add Items
					$Count=0;
					for($i=0;$i<$NumSaleItem;$i++) { 
					   if($arrySaleItem[$i]['DropshipCheck']==1){
						
						$arryPurchaseItem[$Count]['sku'] = $arrySaleItem[$i]['sku'];
						$arryPurchaseItem[$Count]['item_id'] = $arrySaleItem[$i]['item_id'];
						$arryPurchaseItem[$Count]['description'] = $arrySaleItem[$i]['description'];
						$arryPurchaseItem[$Count]['on_hand_qty'] = $arrySaleItem[$i]['on_hand_qty'];
						$arryPurchaseItem[$Count]['qty'] = $arrySaleItem[$i]['qty'];
						$arryPurchaseItem[$Count]['price'] = $arrySaleItem[$i]['price'];
						$arryPurchaseItem[$Count]['DropshipCost'] = $arrySaleItem[$i]['DropshipCost'];
						$arryPurchaseItem[$Count]['tax_id'] = $arrySaleItem[$i]['tax_id'];
						$arryPurchaseItem[$Count]['Taxable'] = $arrySaleItem[$i]['Taxable'];
						$arryPurchaseItem[$Count]['amount'] = $arrySaleItem[$i]['amount'];
						$TotalAmount += $arryPurchaseItem[$Count]['amount'];

						$Count++;

					   }
					}
				#}
				
			}
		}

		$arryPurchase[0]['TotalAmount'] = $TotalAmount;
		$NumLine = sizeof($arryPurchaseItem);
		if($NumLine==0){
			$errMsg = '<b>'.NO_DROPSHIP_ITEM.'</b>';
		}
		$arryPurchase[0]['wName'] =  $arrySale[0]['CustomerName'];
		$arryPurchase[0]['wAddress'] =  $arrySale[0]['ShippingAddress'];
		$arryPurchase[0]['wCity'] =  $arrySale[0]['ShippingCity'];
		$arryPurchase[0]['wState'] =  $arrySale[0]['ShippingState'];
		$arryPurchase[0]['wCountry'] =  $arrySale[0]['ShippingCountry'];
		$arryPurchase[0]['wZipCode'] =  $arrySale[0]['ShippingZipCode'];
		$arryPurchase[0]['wContact'] =  $arrySale[0]['CustomerName'];
		$arryPurchase[0]['wMobile'] =  $arrySale[0]['ShippingMobile'];
		$arryPurchase[0]['wLandline'] =  $arrySale[0]['ShippingLandline'];
		$arryPurchase[0]['wEmail'] =  $arrySale[0]['ShippingEmail'];

	}
	
	/************************************/

         $ConditionDrop  =$objCondition-> GetConditionDropValue();

	if(empty($NumLine)) $NumLine = 1;

	//$ErrorMSG = UNDER_CONSTRUCTION; 
        


	require_once("../includes/footer.php"); 	 
?>


